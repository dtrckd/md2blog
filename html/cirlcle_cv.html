<p><span class="citation">@cv</span> <span class="citation">@python</span></p>
<p>view-source:http://txt.arboreus.com/2014/10/21/remove-circles-from-an-image-in-python.html</p>
<div id="header" class="pure-menu pure-menu-open pure-menu-horizontal">
<ul>
<li><a href="/" title="*.txt">&lt;&lt; contents</a></li>
<li><a href="/tagged/en.html">en</a></li>
<li><a href="/tagged/image-processing.html">image-processing</a></li>
<li><a href="/tagged/python.html">python</a></li>
<li><a href="/tagged/opencv.html">opencv</a></li>
<li><a href="/feed.atom">atom feed</a></li>
</ul>
</div>
<div id="content-wrapper">
<div id="content">
<div class="entry">
<h1 id="remove-circles-from-an-image-in-python">Remove circles from an image in Python</h1>
<p><span id="published-date">2014-10-21</span></p>
<p>This post is a follow-up to a post by <em>Steve on Image Processing</em> on how to remove circles from an image by specifying their center and radius. Read <a href="http://blogs.mathworks.com/steve/2014/07/31/filling-circles/">Filling circles</a> to see how to do it in Matlab. I'll show how to do it in Python with SciPy and OpenCV.</p>
<p>Some initial imports we'll need:</p>
<pre><code>  import cv2
      import numpy as np

      The starting point is an image with some circular objects:

      ![coins.png](/media/image/coins.png)</code></pre>
<p>To read this file as a grayscale image I do:</p>
<pre><code>  img = cv2.imread(&quot;coins.png&quot;, cv2.IMREAD_GRAYSCALE)

  Let&#39;s hide the coin at `x=348`, `y=317` and radius 45 pixels. Similar to Matlab recipe, we create a mask first.

      # location and size of the circle
      xc, yc, r = 348, 317, 45
          # size of the image
          H, W = img.shape
              # x and y coordinates per every pixel of the image
              x, y = np.meshgrid(np.arange(W), np.arange(H))
  # squared distance from the center of the circle
  d2 = (x - xc)**2 + (y - yc)**2
      # mask is True inside of the circle
      mask = d2 &lt; r**2

      ![coin-mask.png](/media/image/coin-mask.png)</code></pre>
<p>We may simply set image to black (<code>0</code>) or white (<code>255</code>) under the mask as in the Matlab recipe, or we may calculate an average color outside of the coin, and fill inner pixels with this color:</p>
<pre><code>  outside = np.ma.masked_where(mask, img)
  average_color = outside.mean()
  img[mask] = average_color

  New image now looks like this:

  ![coin-masked.png](/media/image/coin-masked.png)</code></pre>
<p>The coin is missing, but the circle is clearly visible. A nicer way to fill the circle is to use OpenCV <a href="http://docs.opencv.org/modules/photo/doc/inpainting.html#inpaint"><code>inpaint</code></a> function. It will reconstruct the missing part from the pixels around it.</p>
<pre><code>  # we need to convert the mask to 8bit single channel image
  bytemask = np.asarray(mask*255, dtype=np.uint8)
  inpainted = cv2.inpaint(img, bytemask, inpaintRadius=10, flags=cv2.INPAINT_TELEA)</code></pre>
<p>The inpainted image:</p>
<div class="figure">
<img src="/media/image/coin-inpainted.png" alt="coin-inpainted.png" />
<p class="caption">coin-inpainted.png</p>
</div>
<p>Now what if I wanted to find and remove all coins automatically? The approach suggested in Steve's article (apply binary threshold to mask all coins which <em>happen</em> to be brighter than the background) will not work, unless I carefully select a different background and take care of uniform illumination.</p>
<p>A different approach is to use <a href="http://docs.opencv.org/modules/imgproc/doc/feature_detection.html#houghcircles">Hough transform</a> to detect circles:</p>
<pre><code>  circles = cv2.HoughCircles(img, cv2.cv.CV_HOUGH_GRADIENT,
                                     dp=1.5, minDist=30, minRadius=15, maxRadius=60)</code></pre>
<p>Hough transform is somewhat finicky as far as parameters should be selected on a case-by-case basis. Beyond the parameters in the example above you may want to adjust two other parameters: <code>param1</code> (default value is 100), which more or less translates into sensitivity of the edge detection procedure (see <a href="http://docs.opencv.org/modules/imgproc/doc/feature_detection.html#houghcircles">OpenCV docs</a> for a more techinal definition), and <code>param2</code> (default value is 100) is a circle detection threshold. The smaller is <code>param2</code>, the more false circles will be detected.</p>
<p>To make sure only the right circles were selected we'll draw them over the original color image:</p>
<pre><code>  color_img = cv2.imread(&quot;coins.png&quot;)
      red = (0,0,255)
  for x, y, r in circles[0]:
          cv2.circle(color_img, (x,y), r, red, 2)</code></pre>
<div class="figure">
<img src="/media/image/coins-detected.png" alt="coins-detected.png" />
<p class="caption">coins-detected.png</p>
</div>
<p>The detected circles are not very precise, they don't cover shadow and reflex zone around the coin, so we may want to make them slightly bigger when creating a mask.</p>
<pre><code>  black = np.zeros(img.shape)
  for x, y, r in circles[0]:
          cv2.circle(black, (x,y), int(r+15), 255, -1)  # -1 to draw filled circles

          ![coins-mask.png](/media/image/coins-mask.png)</code></pre>
<p>Now we may simply inpaint all found coins:</p>
<pre><code>  bytemask = np.asarray(black, dtype=np.uint8)
  inpainted = cv2.inpaint(img, bytemask, inpaintRadius=5, flags=cv2.INPAINT_TELEA)</code></pre>
<p>And all coins magically disappear:</p>
<div class="figure">
<img src="/media/image/coins-all-inpainted.png" alt="coins-all-inpainted.png" />
<p class="caption">coins-all-inpainted.png</p>
</div>
<p>We used three OpenCV features:</p>
<ul>
<li>Hough transform</li>
<li><code>inpaint</code> function</li>
<li>primitive drawing procedures (<code>cv2.circle</code>)</li>
</ul>
<p>If we skip inpainting, which is unique to OpenCV right now, we may also do everything in scikit-image. It tends to have a nicer Python interface. Let me know if you'd like to see some examples.</p>
<p>If you like this post, you may also like <a href="/2012/12/20/counting-objects-and-calculating-objects-density-in.html">Counting objects and calculating objects' density in Python</a>.</p>
<div class="tags">
<span class="tag"><a href="/tagged/en.html">en</a></span><span class="tag"><a href="/tagged/image-processing.html">image-processing</a></span><span class="tag"><a href="/tagged/python.html">python</a></span><span class="tag"><a href="/tagged/opencv.html">opencv</a></span>
</div>
<div id="feedback">
<script type="text/javascript">
<!--
h='&#x61;&#114;&#98;&#x6f;&#114;&#x65;&#x75;&#x73;&#46;&#x63;&#x6f;&#x6d;&#x25;&#x33;&#x45;&#x3f;&#x73;&#x75;&#98;&#106;&#x65;&#x63;&#116;&#x3d;&#x25;&#x35;&#66;&#42;&#46;&#116;&#120;&#116;&#x25;&#x35;&#68;&#x25;&#50;&#48;&#82;&#x65;&#x6d;&#x6f;&#118;&#x65;&#x25;&#50;&#48;&#x63;&#x69;&#114;&#x63;&#108;&#x65;&#x73;&#x25;&#50;&#48;&#102;&#114;&#x6f;&#x6d;&#x25;&#50;&#48;&#x61;&#110;&#x25;&#50;&#48;&#x69;&#x6d;&#x61;&#x67;&#x65;&#x25;&#50;&#48;&#x69;&#110;&#x25;&#50;&#48;&#80;&#x79;&#116;&#104;&#x6f;&#110;&#38;&#98;&#x6f;&#100;&#x79;&#x3d;&#x25;&#x35;&#66;&#x57;&#114;&#x69;&#116;&#x65;&#x25;&#50;&#48;&#x79;&#x6f;&#x75;&#114;&#x25;&#50;&#48;&#x63;&#x6f;&#x6d;&#x6d;&#x65;&#110;&#116;&#x25;&#50;&#48;&#104;&#x65;&#114;&#x65;&#x25;&#50;&#48;&#x61;&#110;&#100;&#x25;&#50;&#48;&#x73;&#x65;&#110;&#100;&#x25;&#50;&#48;&#x6d;&#x65;&#x25;&#50;&#48;&#116;&#104;&#x65;&#x25;&#50;&#48;&#x6d;&#x65;&#x73;&#x73;&#x61;&#x67;&#x65;&#x25;&#x35;&#68;';a='&#64;';n='&#x53;&#x65;&#114;&#x67;&#x65;&#x79;&#x25;&#50;&#48;&#x41;&#x73;&#116;&#x61;&#110;&#x69;&#110;&#x25;&#50;&#48;&#x25;&#x33;&#x43;&#116;&#120;&#116;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'" clas'+'s="em' + 'ail">'+'&#x43;&#x6f;&#x6d;&#x6d;&#x65;&#110;&#116;'+'<\/'+'a'+'>');
// -->
</script><noscript>&#x43;&#x6f;&#x6d;&#x6d;&#x65;&#110;&#116;&#32;&#40;&#x53;&#x65;&#114;&#x67;&#x65;&#x79;&#x25;&#50;&#48;&#x41;&#x73;&#116;&#x61;&#110;&#x69;&#110;&#x25;&#50;&#48;&#x25;&#x33;&#x43;&#116;&#120;&#116;&#32;&#x61;&#116;&#32;&#x61;&#114;&#98;&#x6f;&#114;&#x65;&#x75;&#x73;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;&#x25;&#x33;&#x45;&#x3f;&#x73;&#x75;&#98;&#106;&#x65;&#x63;&#116;&#x3d;&#x25;&#x35;&#66;&#42;&#32;&#100;&#x6f;&#116;&#32;&#116;&#120;&#116;&#x25;&#x35;&#68;&#x25;&#50;&#48;&#82;&#x65;&#x6d;&#x6f;&#118;&#x65;&#x25;&#50;&#48;&#x63;&#x69;&#114;&#x63;&#108;&#x65;&#x73;&#x25;&#50;&#48;&#102;&#114;&#x6f;&#x6d;&#x25;&#50;&#48;&#x61;&#110;&#x25;&#50;&#48;&#x69;&#x6d;&#x61;&#x67;&#x65;&#x25;&#50;&#48;&#x69;&#110;&#x25;&#50;&#48;&#80;&#x79;&#116;&#104;&#x6f;&#110;&#38;&#98;&#x6f;&#100;&#x79;&#x3d;&#x25;&#x35;&#66;&#x57;&#114;&#x69;&#116;&#x65;&#x25;&#50;&#48;&#x79;&#x6f;&#x75;&#114;&#x25;&#50;&#48;&#x63;&#x6f;&#x6d;&#x6d;&#x65;&#110;&#116;&#x25;&#50;&#48;&#104;&#x65;&#114;&#x65;&#x25;&#50;&#48;&#x61;&#110;&#100;&#x25;&#50;&#48;&#x73;&#x65;&#110;&#100;&#x25;&#50;&#48;&#x6d;&#x65;&#x25;&#50;&#48;&#116;&#104;&#x65;&#x25;&#50;&#48;&#x6d;&#x65;&#x73;&#x73;&#x61;&#x67;&#x65;&#x25;&#x35;&#68;&#x29;</noscript>
</div>
</div>
</div>
</div>
<script>hljs.initHighlightingOnLoad();</script>
